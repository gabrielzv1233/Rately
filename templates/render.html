{% extends "base.html" %}
{% set title = "Rately" %}
{% block headstyle %}
.wrap{ height:100%; padding:24px; display:flex; gap:16px }
.left{ flex:0 0 420px; background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column }
.right{ flex:1; background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); display:flex; flex-direction:column; justify-content:center; align-items:center }
.list-head{ text-align: center; padding:12px 14px; font-weight:800; border-bottom:1px solid var(--border) }
.list{ overflow:auto; padding:8px; display:flex; flex-direction:column; gap:8px }
.item{ display:flex; gap:10px; align-items:center; padding:10px; border:1px solid var(--border); border-radius:12px; background:var(--panel2); cursor:pointer }
.item:hover{ background:#1b1e28 }
.icov{ width:44px;height:44px;border-radius:10px;overflow:hidden; background:#222; flex:0 0 auto }
.itxt{ display:flex; flex-direction:column; gap:2px; min-width:0 }
.ttl{ font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.art{ color:var(--sub); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.preview{ padding:16px; display:flex; flex-direction:column; align-items:center; gap:12px }
img.card{ width:min(380px, 42vw); border-radius:16px; border:1px solid var(--border) }
.topbar{ position:absolute; top:18px; left:18px; display:flex; gap:10px }
button.btn {margin-right: 5px;}
{% endblock %}
{% block body %}
<div class="wrap">
  <div class="left">
    <div class="list-head">
      <button class="btn" onclick="location.href='/'">Home</button><button class="btn" onclick="pickLib()">Pick Library</button><button class="btn" onclick="location.href='/rate'">Rate</button>
    </div>
    <div id="list" class="list"></div>
  </div>
  <div class="right">
    <div class="preview">
      <img id="card" class="card" src="">
      <div>
        <button class="btn btn-accent" onclick="download()">Download PNG ({{CARDRES}})</button>
      </div>
    </div>
  </div>
</div>
<script>
let currentId = null;
async function load(){
  const r = await fetch('/api/tracks'); const j = await r.json();
  const list = document.getElementById('list'); list.innerHTML='';
  (j.tracks||[]).forEach(t=>{
    const div = document.createElement('div'); div.className='item';
    div.onclick=()=>{ select(t.id); };
    div.innerHTML = `
      <div class="icov"><img src="/cover/${t.id}" style="width:100%;height:100%;object-fit:cover"></div>
      <div class="itxt"><div class="ttl">${t.title}</div><div class="art">${t.artist}</div></div>
    `;
    list.appendChild(div);
  });
}
async function select(id){
  currentId = id;
  const r = await fetch(`/api/render/${id}`);
  const blob = await r.blob();
  const u = URL.createObjectURL(blob);
  document.getElementById('card').src = u;
}
function download(){
  if (!currentId) return;
  const a = document.createElement('a'); a.href=`/api/render/${currentId}`; a.download='card.png'; a.click();
}
load();
</script>
{% endblock %}
