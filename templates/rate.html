{% extends "base.html" %}
{% set title = "Rately" %}
{% block headstyle %}
.container{ display:flex; gap:20px; height:100vh; padding:20px; }
.main{
  position:relative; flex:1;
  background:linear-gradient(160deg, rgba(255,45,85,.09), transparent 40%), var(--panel);
  border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:24px; overflow:hidden;
}
.sidebar{
  flex:0 0 360px; width:360px; background:var(--panel); border:1px solid var(--border);
  border-radius:16px; box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:hidden;
}
html,body{ overflow:hidden }

.queue-head{ padding:12px 16px; font-weight:800; border-bottom:1px solid var(--border) }
.queue{ overflow:auto; padding:8px; display:flex; flex-direction:column; gap:8px; height:calc(100% - 48px) }
.queue-item{
  display:flex; align-items:center; gap:12px; padding:10px; border:1px solid var(--border);
  border-radius:12px; background:var(--panel2); cursor:pointer; transition:transform .15s, background .2s;
}
.queue-item:hover{ transform:translateY(-2px); background:#1a1d27 }
.qcov{ width:44px; height:44px; border-radius:10px; overflow:hidden; background:#222; flex:0 0 auto }
.qtxt{ display:flex; flex-direction:column; gap:2px; min-width:0 }
.ttl{ font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.art{ color:var(--sub); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.ratingpill{ margin-left:auto; background:rgba(255,45,85,.15); border:1px solid rgba(255,45,85,.35); color:#ff6f93; border-radius:10px; padding:2px 8px; font-size:12px }

.player{ height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:22px }
.artwrap{ width:min(48vh,48vw); aspect-ratio:1; border-radius:24px; overflow:hidden; background:#0f1118; border:1px solid var(--border); box-shadow:var(--shadow) }
.artwrap img{ width:100%; height:100%; object-fit:cover }
.meta{ text-align:center; display:flex; flex-direction:column; gap:6px }
.songtitle{ font-size: clamp(22px, 3.2vw, 28px); font-weight:800; letter-spacing:.2px }
.songartist{ color:var(--sub); font-size: clamp(14px, 2vw, 16px); font-weight:600 }

.controls{ width:min(720px, 90%); display:flex; flex-direction:column; gap:10px; margin:0 auto }
.range{ appearance:none; width:100%; height:6px; border-radius:999px; background:#202432; outline:none }
.range::-webkit-slider-thumb{ -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:#FF2D55; box-shadow:none; transition:box-shadow .15s }
.range:hover::-webkit-slider-thumb{ box-shadow:0 0 0 8px rgba(255, 45, 85, 0.25) }
.range::-moz-range-track{ height:6px; background:#311F16; border-radius:999px }
.range::-moz-range-thumb{ width:18px; height:18px; border-radius:50%; background:#FF2D55; border:none }
.time{ display:flex; justify-content:space-between; color:var(--sub); font-size:12px }

.ctrl-row{ display:flex; align-items:center; justify-content:center; gap:12px; margin-top:6px }
.iconbtn{ width:42px; height:42px; border-radius:50%; border:1px solid var(--border); background:var(--panel2); display:grid; place-items:center; cursor:pointer }
.iconbtn svg{ width:20px; height:20px; fill:#E5E7F4 }
.iconbtn:hover{ background:#1b1e28 }

.vol{ display:flex; align-items:center; justify-content:center }
#volume{ width:90% }

.mono{ font-variant-numeric: tabular-nums }

.modal{ position:fixed; inset:0; background:rgba(0,0,12,.52); display:none; align-items:center; justify-content:center; z-index:5 }
.modal.show{ display:flex; animation:fadeIn .25s ease }
@keyframes fadeIn{ from{opacity:0} to{opacity:1} }
.modal-card{
  width:min(520px, 92%); background:var(--panel); border:1px solid var(--border); border-radius:20px; box-shadow:var(--shadow);
  padding:20px 20px 64px; display:flex; flex-direction:column; gap:12px; position:relative; transform:translateY(6px); animation:pop .24s ease forwards;
}
@keyframes pop{ to{ transform:translateY(0) } }
.modal-x{ position:absolute; top:10px; right:10px; width:36px; height:36px; border-radius:12px; border:1px solid var(--border); background:var(--panel2); display:grid; place-items:center; cursor:pointer }
.modal-title{ font-weight:800; font-size:18px; padding-right:44px }
.modal-fields{ display:flex; flex-direction:column; gap:10px }
.input-rating{ height:42px }
.textarea{ min-height:5lh; resize:vertical }
.modal-confirm{ position:absolute; left:50%; transform:translateX(-50%); bottom:14px }

#toast{ position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#131724; border:1px solid #2a3147; color:#e0e6ff; padding:10px 14px; border-radius:12px; display:none }
{% endblock %}
{% block body %}
<div class="container">
  <div class="main">
    <div class="player">
      <div class="artwrap"><img id="cover" src="" alt=""></div>

      <div class="meta">
        <div id="title" class="songtitle">—</div>
        <div id="artist" class="songartist">—</div>
      </div>

      <div class="controls">
        <input id="seek" class="range" type="range" min="0" max="100" value="0">
        <div class="time mono"><span id="tcur">0:00</span><span id="tend">0:00</span></div>
        
        <div class="vol">
          <input id="volume" class="range" type="range" min="0" max="1" step="0.01" value="1">
        </div>

        <div class="ctrl-row">
          <button class="iconbtn" onclick="openRating(true)" title="Rate">
            <svg viewBox="0 0 24 24"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>
          </button>
          <button class="iconbtn" onclick="prev()" title="Prev"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zM20 6v12l-10-6z"/></svg></button>
          <button class="iconbtn" onclick="togglePlay()" id="playbtn" title="Play/Pause"><svg id="playicon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
          <button class="iconbtn" onclick="next()" title="Next"><svg viewBox="0 0 24 24"><path d="M18 6v12h-2V6zM4 6l10 6-10 6z"/></svg></button>
          <button class="iconbtn" onclick="toggleQueue()" title="Queue">
            <svg viewBox="0 0 24 24">
              <circle cx="5" cy="7" r="2"></circle><rect x="9" y="6" width="10" height="2"></rect>
              <circle cx="5" cy="12" r="2"></circle><rect x="9" y="11" width="10" height="2"></rect>
              <circle cx="5" cy="17" r="2"></circle><rect x="9" y="16" width="10" height="2"></rect>
            </svg>
          </button>
        </div>        
      </div>
    </div>
  </div>

  <div id="side" class="sidebar">
    <div class="queue-head">Queue</div>
    <div id="queue" class="queue"></div>
    </button><button class="btn" onclick="location.href='/render'">Render </button>
  </div>
</div>

<div id="modal" class="modal" onclick="bgClose(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <button class="modal-x" onclick="cancelModal(true)" title="Close">
      <svg viewBox="0 0 24 24" width="18" height="18"><path fill="#e5e7f4" d="M18.3 5.71 12 12.01l6.3 6.29-1.41 1.41L10.59 13.4l-6.3 6.3-1.41-1.42 6.3-6.29-6.3-6.3L4.3 4.3l6.3 6.3 6.29-6.3z"/></svg>
    </button>
    <div class="modal-title">Rate Track</div>
    <div class="modal-fields">
      <input id="rating" class="input input-rating mono" type="number" min="0" max="10" step="0.01" placeholder="x/10 (e.g. 7.85)">
      <textarea id="comment" class="input textarea" rows="5" placeholder="Comments (optional)"></textarea>
    </div>
    <div class="modal-confirm">
      <button class="btn btn-accent" onclick="submitRating()">Confirm</button>
      <button class="btn" onclick="cancelModal(false)" style="margin-left:8px;">Cancel</button>
    </div>
  </div>
</div>

<audio id="audio"></audio>
<div id="toast"></div>

<script>
let LIB = [];
let idx = 0;
let played = new Set();
let autoPopup = false;
let manualPopup = false;
let suppressEndPopup = false;
let modalOpen = false;

const audio = document.getElementById('audio');
const seek = document.getElementById('seek');
const vol = document.getElementById('volume');
const tcur = document.getElementById('tcur');
const tend = document.getElementById('tend');
const cover = document.getElementById('cover');
const titleEl = document.getElementById('title');
const artistEl = document.getElementById('artist');
const queueEl = document.getElementById('queue');
const side = document.getElementById('side');
const container = document.querySelector('.container');
let sideDetached = false;
let sideNode = side;

function toggleQueue(){
  if (!sideDetached){
    if (sideNode.parentNode) sideNode.parentNode.removeChild(sideNode);
    sideDetached = true;
  } else {
    container.appendChild(sideNode);
    sideDetached = false;
    buildQueue();
  }
}

function toast(msg){
  const el = document.getElementById('toast');
  el.textContent = msg; el.style.display='block';
  setTimeout(()=>{ el.style.display='none'; }, 1600);
}

async function pickLib(){
  const s = await fetch('/pick_library_start',{method:'POST'});
  const jr = await s.json();
  if(!jr.ok) return promptPath();
  const id = jr.job_id;
  for(let i=0;i<200;i++){
    await new Promise(res=>setTimeout(res,100));
    const st = await fetch('/pick_library_status?job_id='+id);
    const sj = await st.json();
    if (sj.done){
      if (sj.path){
        await fetch('/set_library',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path:sj.path})});
        await loadLib(); return;
      } else { return promptPath(); }
    }
  }
  promptPath();
}
function promptPath(){
  const p = prompt("Enter your music folder full path:");
  if (p && p.trim()) fetch('/set_library',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path:p.trim()})}).then(loadLib);
}

async function loadLib(){
  const r = await fetch('/api/tracks');
  const j = await r.json();
  LIB = j.tracks || [];
  idx = 0; played = new Set();
  buildQueue();
  if (LIB.length) loadCurrent();
  else toast('No tracks found');
}

function buildQueue(){
  if (!queueEl) return;
  queueEl.innerHTML = '';
  LIB.forEach((t,i)=>{
    if (i===idx) return;
    if (played.has(i)) return;
    const div = document.createElement('div');
    div.className='queue-item';
    div.onclick=()=>{ idx=i; loadCurrent(true); };
    div.innerHTML = `
      <div class="qcov"><img src="/cover/${t.id}" style="width:100%;height:100%;object-fit:cover"/></div>
      <div class="qtxt">
        <div class="ttl">${t.display_title || t.title}</div>
        <div class="art">${t.display_artist || t.artist || ''}</div>
      </div>
      ${ t.rating_exact !== null ? `<div class="ratingpill">${t.rating_exact.toFixed(2)}/10</div>` : '' }
    `;
    queueEl.appendChild(div);
  });
}

function prettyTime(s){
  if(!isFinite(s)||s<0) s=0;
  const m = Math.floor(s/60), sec = Math.floor(s%60).toString().padStart(2,'0');
  return `${m}:${sec}`;
}

function wipeFields(){ document.getElementById('rating').value=''; document.getElementById('comment').value=''; }

function loadCurrent(play=false){
  if(!LIB.length) return;
  wipeFields();
  const t = LIB[idx];
  audio.src = `/audio/${t.id}`;
  cover.src = `/cover/${t.id}`;
  titleEl.textContent  = t.display_title  || t.title  || 'Unknown Title';
  artistEl.textContent = t.display_artist || t.artist || 'Unknown Artist';
  seek.value = 0; seek.max = 100; tcur.textContent='0:00'; tend.textContent=prettyTime(t.duration || 0);
  suppressEndPopup = false;
  buildQueue();
  if (play!==false) audio.play();
}

function prev(){ if(!LIB.length) return; idx=(idx-1+LIB.length)%LIB.length; loadCurrent(true); }
function next(){ if(!LIB.length) return; if(!played.has(idx)) played.add(idx); idx=(idx+1)%LIB.length; loadCurrent(true); }
function togglePlay(){ if(audio.paused) audio.play(); else audio.pause(); }
audio.addEventListener('play', ()=>{ document.getElementById('playicon').innerHTML='<path d="M6 5h4v14H6zM14 5h4v14h-4z"/>'; });
audio.addEventListener('pause', ()=>{ document.getElementById('playicon').innerHTML='<path d="M8 5v14l11-7z"/>'; });

audio.addEventListener('timeupdate', ()=>{
  if(!audio.duration) return;
  seek.value = (audio.currentTime/audio.duration)*100;
  tcur.textContent = prettyTime(audio.currentTime);
  tend.textContent = prettyTime(audio.duration);
});
seek.addEventListener('input', ()=>{ if(audio.duration) audio.currentTime = (seek.value/100)*audio.duration; });
vol.addEventListener('input', ()=>{ audio.volume = parseFloat(vol.value); });

audio.addEventListener('ended', ()=>{
  if (manualPopup){ next(); return; }
  if (suppressEndPopup){ next(); return; }
  autoPopup = true; manualPopup = false;
  openRating(false);
});

function openRating(manual){
  manualPopup = !!manual; autoPopup = !manual; modalOpen = true;
  document.getElementById('modal').classList.add('show');
}
function cancelModal(escCancel){
  if (!escCancel) wipeFields();
  closeModal();
}
function closeModal(){
  document.getElementById('modal').classList.remove('show');
  setTimeout(()=>{ autoPopup=false; manualPopup=false; modalOpen=false; },100);
}
function bgClose(e){ if(e.target.id==='modal') cancelModal(false); }

document.addEventListener('keydown', (ev)=>{
  if (ev.key === 'Escape' && modalOpen){
    ev.preventDefault(); cancelModal(true);
  }
});

async function submitRating(){
  const t = LIB[idx]; if(!t) return;
  const val = parseFloat(document.getElementById('rating').value);
  const cmt = document.getElementById('comment').value.trim();
  if(!isFinite(val)){ toast('Enter a number like 7.85'); return; }
  const r = await fetch(`/api/rate/${t.id}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({rating:val, comment:cmt})});
  const j = await r.json();
  if(!j.ok){ toast('Failed to save'); return; }
  toast('Saved ✔'); LIB[idx].rating_exact = val; closeModal();
  if(autoPopup){ next(); } else { suppressEndPopup = true; }
  buildQueue();
}

(async function boot(){
  const r = await fetch('/api/tracks');
  const j = await r.json();
  if(!j.tracks || !j.tracks.length){ await pickLib(); }
  else { LIB=j.tracks; idx=0; played=new Set(); buildQueue(); loadCurrent(); }
})();
</script>
{% endblock %}
