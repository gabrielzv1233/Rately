{% extends "base.html" %}
{% set title = "Rately" %}
{% block headstyle %}
.container{ display:flex; gap:20px; height:100vh; padding:20px; }
.main{
  position:relative; flex:1;
  background:linear-gradient(160deg, rgba(255,45,85,.09), transparent 40%), var(--panel);
  border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:24px; overflow:hidden;
}
.sidebar{
  flex:0 0 360px; width:360px; background:var(--panel); border:1px solid var(--border);
  border-radius:16px; box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:hidden;
}
html,body{ overflow:hidden }

.queue-head{
  padding:12px 12px; font-weight:800; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:10px;
}
.queue-head .label{ white-space:nowrap }
.queue-head input[type="search"]{
  flex:1; height:34px; border-radius:10px; border:1px solid var(--border);
  background:var(--panel2); color:var(--text); padding:6px 10px; outline:none;
}
.queue-head input[type="search"]::placeholder{ color:#8b92a6 }

.queue{ flex:1; overflow:auto; padding:8px; display:flex; flex-direction:column; gap:8px; }
.queue-item{
  display:flex; align-items:center; gap:12px; padding:10px; border:1px solid var(--border);
  border-radius:12px; background:var(--panel2); cursor:pointer; transition:transform .15s, background .2s;
}
.queue-item:hover{ transform:translateY(-2px); background:#1a1d27 }
.qcov{ width:44px; height:44px; border-radius:10px; overflow:hidden; background:#222; flex:0 0 auto }
.qtxt{ display:flex; flex-direction:column; gap:2px; min-width:0 }
.ttl{ font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.art{ color:var(--sub); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.ratingpill{ margin-left:auto; background:rgba(255,45,85,.15); border:1px solid rgba(255,45,85,.35); color:#ff6f93; border-radius:10px; padding:2px 8px; font-size:12px }

.player{ height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:22px }
.artwrap{ width:min(48vh,48vw); aspect-ratio:1; border-radius:24px; overflow:hidden; background:#0f1118; border:1px solid var(--border); box-shadow:var(--shadow) }
.artwrap img{ width:100%; height:100%; object-fit:cover }
.meta{ text-align:center; display:flex; flex-direction:column; gap:6px }
.songtitle{ font-size: clamp(22px, 3.2vw, 28px); font-weight:800; letter-spacing:.2px }
.songartist{ color:var(--sub); font-size: clamp(14px, 2vw, 16px); font-weight:600 }

.controls{ width:min(720px, 90%); display:flex; flex-direction:column; gap:10px; margin:0 auto }
.range{ appearance:none; width:100%; height:6px; border-radius:999px; background:#202432; outline:none }
.range::-webkit-slider-thumb{ -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:#FF2D55; box-shadow:none; transition:box-shadow .15s }
.range:hover::-webkit-slider-thumb{ box-shadow:0 0 0 8px rgba(255, 45, 85, 0.25) }
.range::-moz-range-track{ height:6px; background:#311F16; border-radius:999px }
.range::-moz-range-thumb{ width:18px; height:18px; border-radius:50%; background:#FF2D55; border:none }
.time{ display:flex; justify-content:space-between; color:var(--sub); font-size:12px }

.ctrl-row{ display:flex; align-items:center; justify-content:center; gap:12px; margin-top:6px }
.iconbtn{ width:42px; height:42px; border-radius:50%; border:1px solid var(--border); background:var(--panel2); display:grid; place-items:center; cursor:pointer }
.iconbtn svg{ width:20px; height:20px; fill:#E5E7F4 }
.iconbtn:hover{ background:#1b1e28 }

.vol{ display:flex; align-items:center; justify-content:center }
#volume{ width:90% }

.mono{ font-variant-numeric: tabular-nums }

.modal{ position:fixed; inset:0; background:rgba(0,0,12,.52); display:none; align-items:center; justify-content:center; z-index:5 }
.modal.show{ display:flex; animation:fadeIn .25s ease }
@keyframes fadeIn{ from{opacity:0} to{opacity:1} }
.modal-card{
  width:min(520px, 92%); background:var(--panel); border:1px solid var(--border); border-radius:20px; box-shadow:var(--shadow);
  padding:20px 20px 64px; display:flex; flex-direction:column; gap:12px; position:relative; transform:translateY(6px); animation:pop .24s ease forwards;
}
@keyframes pop{ to{ transform:translateY(0) } }
.modal-x{ position:absolute; top:10px; right:10px; width:36px; height:36px; border-radius:12px; border:1px solid var(--border); background:var(--panel2); display:grid; place-items:center; cursor:pointer }
.modal-title{ font-weight:800; font-size:18px; padding-right:44px }
.modal-fields{ display:flex; flex-direction:column; gap:10px }
.input-rating{ height:42px }
.textarea{ min-height:5lh; resize:vertical }
.modal-confirm{ position:absolute; left:50%; transform:translateX(-50%); bottom:14px }

#toast{ position:fixed; bottom:18px; left:50%; transform:translateX(-50%); background:#131724; border:1px solid #2a3147; color:#e0e6ff; padding:10px 14px; border-radius:12px; display:none }

.queue-item.active{ border-color: var(--accent); background: linear-gradient(180deg, rgba(255,45,85,.08), transparent); }
.queue-item.active .ratingpill{ border-color: rgba(255,45,85,.6); }
{% endblock %}

{% block body %}
<div class="container">
  <div class="main">
    <div class="player">
      <div class="artwrap"><img id="cover" src="" alt=""></div>

      <div class="meta">
        <div id="title" class="songtitle">—</div>
        <div id="artist" class="songartist">—</div>
      </div>

      <div class="controls">
        <input id="seek" class="range" type="range" min="0" max="100" value="0">
        <div class="time mono"><span id="tcur">0:00</span><span id="tend">0:00</span></div>
        
        <div class="vol">
          <input id="volume" class="range" type="range" min="0" max="1" step="0.01" value="1">
        </div>

        <div class="ctrl-row">
          <button class="iconbtn" onclick="openRating(true)" title="Rate">
            <svg viewBox="0 0 24 24"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>
          </button>
          <button class="iconbtn" onclick="prev()" title="Prev"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zM20 6v12l-10-6z"/></svg></button>
          <button class="iconbtn" onclick="togglePlay()" id="playbtn" title="Play/Pause"><svg id="playicon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
          <button class="iconbtn" onclick="next()" title="Next"><svg viewBox="0 0 24 24"><path d="M18 6v12h-2V6zM4 6l10 6-10 6z"/></svg></button>
          <button class="iconbtn" onclick="toggleQueue()" title="Library">
            <svg viewBox="0 0 24 24">
              <circle cx="5" cy="7" r="2"></circle><rect x="9" y="6" width="10" height="2"></rect>
              <circle cx="5" cy="12" r="2"></circle><rect x="9" y="11" width="10" height="2"></rect>
              <circle cx="5" cy="17" r="2"></circle><rect x="9" y="16" width="10" height="2"></rect>
            </svg>
          </button>
        </div>        
      </div>
    </div>
  </div>

  <div id="side" class="sidebar">
    <div class="queue-head">
      <div class="label">Library</div>
      <input id="q" type="search" placeholder="Search library…">
    </div>
    <div id="queue" class="queue"></div>
    <button class="btn" style="margin:8px" onclick="goRender()">Render</button>
  </div>
</div>

<div id="modal" class="modal" onmousedown="bgDown(event)" onclick="bgClick(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <button class="modal-x" onclick="cancelModal(true)" title="Close">
      <svg viewBox="0 0 24 24" width="18" height="18"><path fill="#e5e7f4" d="M18.3 5.71 12 12.01l6.3 6.29-1.41 1.41L10.59 13.4l-6.3 6.3-1.41-1.42 6.3-6.29-6.3-6.3L4.3 4.3l6.3 6.3 6.29-6.3z"/></svg>
    </button>
    <div class="modal-title">Rate Track</div>
    <div class="modal-fields">
      <input id="rating" class="input input-rating mono" type="number" min="0" max="10" step="0.01" placeholder="0/10 (e.g. 7.85)">
      <textarea id="comment" class="input textarea" rows="5" placeholder="Comments (optional)"></textarea>
    </div>
    <div class="modal-confirm">
      <button class="btn btn-accent" onclick="submitRating()">Confirm</button>
      <button class="btn" onclick="cancelModal(false)" style="margin-left:8px;">Cancel</button>
    </div>
  </div>
</div>

<audio id="audio"></audio>
<div id="toast"></div>

<script>
let LIB = [];
let idx = 0;
let played = new Set();
let autoPopup = false;
let manualPopup = false;
let suppressEndPopup = false;
let modalOpen = false;

const audio = document.getElementById('audio');
const seek = document.getElementById('seek');
const vol = document.getElementById('volume');
const tcur = document.getElementById('tcur');
const tend = document.getElementById('tend');
const cover = document.getElementById('cover');
const titleEl = document.getElementById('title');
const artistEl = document.getElementById('artist');
const queueEl = document.getElementById('queue');
const container = document.querySelector('.container');
const qbox = document.getElementById('q');

function versioned(path, v){ return `${path}${path.includes('?')?'&':'?'}v=${encodeURIComponent(String(v||0))}`; }
function coverUrl(id, w, v){ let url = `/cover/${id}`; if (w) url += `?w=${w}`; return versioned(url, v); }
function audioUrl(id, v){ return versioned(`/audio/${id}`, v); }

vol.addEventListener('input', ()=>{ audio.volume = parseFloat(vol.value); });

function saveVolume(){
  const v = Math.max(0, Math.min(1, parseFloat(vol.value) || 0));
  setCookie('rately_vol', String(v), 365);
}
vol.addEventListener('change', saveVolume);
vol.addEventListener('mouseup', saveVolume);
vol.addEventListener('touchend', saveVolume);
vol.addEventListener('keyup', (e)=>{ if(e.key === 'Enter' || e.key === ' ') saveVolume(); });

let _bgDown = false;
function bgDown(e){ _bgDown = (e.target && e.target.id === 'modal'); }
function bgClick(e){ if (e.target && e.target.id === 'modal' && _bgDown) cancelModal(false); }
document.addEventListener('mouseup', ()=>{ _bgDown = false; });
document.addEventListener('touchend', ()=>{ _bgDown = false; }, true);
document.addEventListener('mouseleave', ()=>{ _bgDown = false; }, true);

function toast(msg){
  const el = document.getElementById('toast');
  el.textContent = msg; el.style.display='block';
  setTimeout(()=>{ el.style.display='none'; }, 1600);
}
function prettyTime(s){
  if(!isFinite(s)||s<0) s=0;
  const m = Math.floor(s/60), sec = Math.floor(s%60).toString().padStart(2,'0');
  return `${m}:${sec}`;
}
function wipeFields(){ document.getElementById('rating').value=''; document.getElementById('comment').value=''; }

function loadCurrent(play=false){
  if(!LIB.length) return;
  wipeFields();
  const t = LIB[idx];
  audio.src = audioUrl(t.id, t.mtime);
  cover.src = coverUrl(t.id, 512, t.mtime);
  const hiC = coverUrl(t.id, 1024, t.mtime);
  const pre = new Image();
  pre.onload = ()=>{ cover.src = hiC; };
  pre.src = hiC;

  titleEl.textContent  = t.display_title  || t.title  || 'Unknown Title';
  artistEl.textContent = t.display_artist || t.artist || 'Unknown Artist';
  seek.value = 0; seek.max = 100; tcur.textContent='0:00'; tend.textContent=prettyTime(t.duration || 0);
  suppressEndPopup = false;
  buildQueue();
  if (play!==false) audio.play();
}

function prev(){ if(!LIB.length) return; idx=(idx-1+LIB.length)%LIB.length; loadCurrent(true); }
function next(){ if(!LIB.length) return; if(!played.has(idx)) played.add(idx); idx=(idx+1)%LIB.length; loadCurrent(true); }
function togglePlay(){ if(audio.paused) audio.play(); else audio.pause(); }

audio.addEventListener('play', ()=>{ document.getElementById('playicon').innerHTML='<path d="M6 5h4v14H6zM14 5h4v14h-4z"/>'; });
audio.addEventListener('pause', ()=>{ document.getElementById('playicon').innerHTML='<path d="M8 5v14l11-7z"/>'; });
audio.addEventListener('timeupdate', ()=>{
  if(!audio.duration) return;
  seek.value = (audio.currentTime/audio.duration)*100;
  tcur.textContent = prettyTime(audio.currentTime);
  tend.textContent = prettyTime(audio.duration);
});
seek.addEventListener('input', ()=>{ if(audio.duration) audio.currentTime = (seek.value/100)*audio.duration; });
vol.addEventListener('input', ()=>{ audio.volume = parseFloat(vol.value); });
audio.addEventListener('ended', ()=>{
  if (manualPopup){ next(); return; }
  if (suppressEndPopup){ next(); return; }
  autoPopup = true; manualPopup = false;
  openRating(false);
});

function openRating(manual){
  manualPopup = !!manual; autoPopup = !manual; modalOpen = true;

  const t = LIB[idx];
  const rInput = document.getElementById('rating');
  const cInput = document.getElementById('comment');

  if (t && t.rating_exact != null) {
    const n = Number(t.rating_exact);
    rInput.value = Number.isInteger(n) ? String(n) : String(n.toFixed(2).replace(/\.00$/,'').replace(/(\.\d)0$/,'$1'));
  } else {
    rInput.value = '';
  }

  cInput.value = (t && t.comment) ? t.comment : '';

  document.getElementById('modal').classList.add('show');
}
function cancelModal(escCancel){
  if (!escCancel) wipeFields();
  closeModal();
}
function closeModal(){
  _bgDown = false;
  document.getElementById('modal').classList.remove('show');
  setTimeout(()=>{ autoPopup=false; manualPopup=false; },100);
}

async function submitRating(){
  const t = LIB[idx]; if(!t) return;
  const ratingStr = document.getElementById('rating').value.trim();
  const cmt = document.getElementById('comment').value.trim();

  const val = ratingStr === '' ? null : parseFloat(ratingStr);
  if (val !== null && !isFinite(val)) { toast('Enter a number like 7.85'); return; }

  const r = await fetch(`/api/rate/${t.id}`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ rating: val, comment: cmt })
  });
  const j = await r.json();
  if(!j.ok){ toast('Failed to save'); return; }

  t.rating_exact = val;
  t.comment = cmt;

  buildQueue();
  toast('Saved ✔');
  closeModal();

  if(autoPopup){ next(); } else { suppressEndPopup = true; }
}

function fmtRating(n){
  if (n == null) return '';
  const x = Number(n);
  if (!Number.isFinite(x)) return '';
  return Number.isInteger(x) ? String(x) :
         String(x.toFixed(2).replace(/\.00$/,'').replace(/(\.\d)0$/,'$1'));
}

function normalizeBase(s){
  return (s || "")
    .toLowerCase()
    .normalize('NFKD')
    .replace(/[\u0300-\u036f]/g,'');
}
function toWords(s){
  return normalizeBase(s).replace(/[^a-z0-9]+/gi,' ').trim().split(/\s+/).filter(Boolean);
}
function flatStr(s){ return toWords(s).join(''); }

function levenshtein(a,b){
  const m=a.length, n=b.length;
  if(m===0) return n; if(n===0) return m;
  const dp=new Array(n+1);
  for(let j=0;j<=n;j++) dp[j]=j;
  for(let i=1;i<=m;i++){
    let prev=dp[0]; dp[0]=i;
    for(let j=1;j<=n;j++){
      const tmp=dp[j];
      dp[j]= (a[i-1]===b[j-1]) ? prev :
        1 + Math.min(prev, dp[j], dp[j-1]);
      prev=tmp;
    }
  }
  return dp[n];
}

function indexTracks(){
  for (const t of LIB){
    const title  = t.display_title  || t.title  || "";
    const artist = t.display_artist || t.artist || "";
    const joined = `${title} ${artist}`;
    t._flat = toFlat(joined);
  }
}

function parseInlineRating(q){
  const m = q.match(/rating\s*:\s*([<>]=?|)(\d+(?:\.\d+)?)(?:\s*-\s*(\d+(?:\.\d+)?))?/i);
  if(!m) return null;
  const op = m[1];
  const a = parseFloat(m[2]);
  const b = m[3] ? parseFloat(m[3]) : null;
  return { op, a, b, raw:m[0] };
}

function matchesRating(track, filt){
  const r = track.rating_exact;
  if (!filt) return true;
  const {op,a,b} = filt;
  if (b!=null){
    const lo=Math.min(a,b), hi=Math.max(a,b);
    return r!=null && r>=lo && r<=hi;
  }
  if (op.includes('>')) return r!=null && r>a;
  if (op.includes('<')) return r!=null && r<a;
  return r!=null && r>=a;
}

function tokenMatch(token, t){
  if (!token) return true;
  if (t._searchText.includes(token)) return true;
  const flatTok = token.replace(/[^a-z0-9]+/gi,'');
  if (flatTok && t._flat.includes(flatTok)) return true;
  
  const th = Math.max(1, Math.ceil(token.length * 0.30));
  for (const w of t._words){
    if (Math.abs(w.length - token.length) > th) continue;
    if (levenshtein(token, w) <= th) return true;
  }
  return false;
}

function textMatches(t, q){
  const qNorm = normalizeSimple(q || "");
  if (!qNorm) return true;
  const tokens = qNorm.split(/\s+/).filter(Boolean).map(tok => tok.replace(/\s+/g,""));
  if (!tokens.length) return true;

  const hay = t._flat || "";
  for (const tok of tokens){
    if (!hay.includes(tok)) return false;
  }
  return true;
}

function normalizeSimple(s){
  return (s || "")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, " ")
    .trim();
}

function toFlat(s){
  return normalizeSimple(s).replace(/\s+/g, "");
}

function currentFilterFromBox() {
  const raw = (qbox && qbox.value) ? qbox.value : '';
  const hf = parseHashFilters(raw);

  const inline = parseInlineRating(hf.text);

  let ratingFilt = null;
  if (hf.rating) {
    ratingFilt = {
      min: hf.rating.min,
      max: hf.rating.max,
      invert: !!hf.ratingInvert
    };
  } else if (inline) {
    ratingFilt = {
      op: inline.op || '',
      a: inline.a,
      b: (inline.b != null ? inline.b : null),
      invert: false
    };
  }

  return {
    q: hf.text,
    rating: ratingFilt,
    rated: hf.rated ?? null,
    ratedInvert: !!hf.ratedInvert
  };
}

function buildQueue(){
  if (!queueEl) return;
  queueEl.innerHTML = '';

  const { q, rating, rated, ratedInvert } = currentFilterFromBox();

  const items = [];
  for (let i = 0; i < LIB.length; i++){
    const t = LIB[i];
      if (!textMatches(t, q)) continue;
      if (!matchesRated(t, rated, ratedInvert)) continue;
      if (!matchesRatingExt(t, rating)) continue;
    items.push([i, t]);
  }

  for (const [i, t] of items){
    const isActive = (i === idx);
    const div = document.createElement('div');
    div.className = 'queue-item' + (isActive ? ' active' : '');
    div.onclick = () => { idx = i; loadCurrent(true); };

    div.innerHTML = `
      <div class="qcov">
        <img src="${coverUrl(t.id,72,t.mtime)}" data-hi="${coverUrl(t.id,256,t.mtime)}" style="width:100%;height:100%;object-fit:cover"/>
      </div>
      <div class="qtxt">
        <div class="ttl">${t.display_title || t.title}</div>
        <div class="art">${t.display_artist || t.artist || ''}</div>
      </div>
      ${t.rating_exact !== null && t.rating_exact !== undefined
          ? `<div class="ratingpill">${fmtRating(t.rating_exact)}/10</div>`
          : ''
      }
    `;
    queueEl.appendChild(div);

    const img = div.querySelector('img');
    if (img){
      const hi = img.getAttribute('data-hi');
      const hiImg = new Image();
      hiImg.onload = () => { img.src = hi; };
      hiImg.src = hi;
    }
  }
}

function debounce(fn, ms){
  let to=null;
  return (...args)=>{ clearTimeout(to); to=setTimeout(()=>fn(...args), ms); };
}

async function loadLib(){
  const r = await fetch('/api/tracks');
  const j = await r.json();
  LIB = j.tracks || [];
  idx = 0; played = new Set();
  indexTracks();
  buildQueue();
  if (LIB.length) loadCurrent();
  else toast('No tracks found');
}

(async function boot(){
  const v = getCookie('rately_vol');
  if (v !== null){
    const fv = Math.max(0, Math.min(1, parseFloat(v)));
    if (isFinite(fv)){ vol.value = String(fv); audio.volume = fv; }
  }

  const r = await fetch('/api/tracks');
  const j = await r.json();
  LIB = j.tracks || [];
  idx = 0; played = new Set();
  indexTracks();
  buildQueue();

  const sel = qs('select');
  if (sel){
    const i = LIB.findIndex(t => t.id === sel);
    if (i >= 0) idx = i;
  }

  if (LIB.length) loadCurrent();
  else { await pickLib(); await loadLib(); }

  qbox.addEventListener('input', debounce(buildQueue, 120));
})();

function setCookie(name, value, days){
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/;SameSite=Lax`;
}
function getCookie(name){
  const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&") + '=([^;]*)'));
  return m ? decodeURIComponent(m[1]) : null;
}

function qs(k){ return new URLSearchParams(location.search).get(k); }
function goRender(){
  const t = LIB[idx];
  location.href = t ? (`/render?select=${encodeURIComponent(t.id)}`) : '/render';
}

function parseHashFilters(q){
  let text = q || '';
  const ratedRe  = /#([!-])?\s*rated\b/i;
  const ratingRe = /#([!-])?\s*rating\s*:\s*([0-9]+(?:\.[0-9]+)?)(?:\s*-\s*([0-9]+(?:\.[0-9]+)?))?/i;

  let rated = null, ratedInvert = false;
  let rating = null, ratingInvert = false;

  const mr = text.match(ratedRe);
  if (mr){
    rated = true;
    ratedInvert = (mr[1] === '!' || mr[1] === '-');
    text = text.replace(mr[0], ' ').trim();
  }

  const mrat = text.match(ratingRe);
  if (mrat){
    const a = parseFloat(mrat[2]);
    const b = (mrat[3] != null) ? parseFloat(mrat[3]) : a;
    const lo = Math.min(a, b), hi = Math.max(a, b);
    rating = { min: lo, max: hi };
    ratingInvert = (mrat[1] === '!' || mrat[1] === '-');
    text = text.replace(mrat[0], ' ').trim();
  }

  return { text, rated, ratedInvert, rating, ratingInvert };
}

function matchesRated(track, ratedFlag, invert){
  if (ratedFlag == null) return true;
  const ok = (track.rating_exact != null);
  return invert ? !ok : ok;
}

function matchesRatingExt(track, filt){
  if (!filt) return true;
  const r = track.rating_exact;
  let ok = true;

  if (filt.min != null && filt.max != null){
    ok = (r != null && r >= filt.min && r <= filt.max);
  } else if (filt.op){
    const {op, a, b} = filt;
    if (b != null){
      const lo = Math.min(a,b), hi = Math.max(a,b);
      ok = (r != null && r >= lo && r <= hi);
    } else if (op.includes('>')) ok = (r != null && r >  a);
      else if (op.includes('<')) ok = (r != null && r <  a);
      else ok = (r != null && r >= a);
  } else if (filt.a != null && filt.b != null){
    const lo = Math.min(filt.a, filt.b), hi = Math.max(filt.a, filt.b);
    ok = (r != null && r >= lo && r <= hi);
  } else if (filt.a != null){
    ok = (r != null && Math.abs(r - filt.a) < 1e-9);
  }

  return filt.invert ? !ok : ok;
}

let sideDetached = false
let sideNode = side;

function toggleQueue(){
  if (!sideDetached){
    if (sideNode.parentNode) sideNode.parentNode.removeChild(sideNode);
    sideDetached = true;
  } else {
    container.appendChild(sideNode);
    sideDetached = false;
    buildQueue();
  }
}
</script>
{% endblock %}